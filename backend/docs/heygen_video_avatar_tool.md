# HeyGen Video Avatar Tool

The HeyGen Video Avatar Tool integrates HeyGen's Streaming Avatar SDK into the Operator platform, enabling agents to create and manage interactive AI video avatars for enhanced user communication.

## Overview

This tool provides comprehensive video avatar functionality including:
- Interactive video avatars with natural speech and lip sync
- Customizable avatar appearance and voice settings
- Real-time conversation capabilities
- Voice chat and text-to-speech functionality
- Session management and state control

## Setup

### Environment Variables

Add the following environment variables to your `.env` file:

```bash
# HeyGen API Configuration
HEYGEN_API_KEY=your_heygen_api_key_here
HEYGEN_API_BASE=https://api.heygen.com
```

### API Key Requirements

1. **HeyGen API Key**: Required for all avatar operations
   - Get your API key from [HeyGen Settings](https://app.heygen.com/settings?nav=API)
   - API Keys are available for Enterprise customers
   - Trial tokens are available for Creator and Teams plan users

2. **Session Tokens**: Automatically generated by the tool using your API key

## Available Functions

### 1. create_avatar_session

Create a new interactive video avatar session with customizable settings.

**Parameters:**
- `session_name` (required): Unique name for the avatar session
- `avatar_id`: HeyGen avatar ID (default: "default")
- `voice_id`: Voice ID for speech (default: "default")
- `voice_rate`: Speech rate 0.5-1.5 (default: 1.0)
- `voice_emotion`: Voice emotion (EXCITED, SERIOUS, FRIENDLY, SOOTHING, BROADCASTER)
- `quality`: Video quality (low, medium, high)
- `language`: Language code (e.g., 'en', 'es', 'fr')
- `knowledge_base`: Custom system prompt for conversations
- `enable_voice_chat`: Enable voice chat capabilities
- `session_timeout`: Session timeout in seconds (30-3600)

**Example:**
```xml
<function_calls>
<invoke name="create_avatar_session">
<parameter name="session_name">customer_service_avatar</parameter>
<parameter name="avatar_id">default</parameter>
<parameter name="voice_emotion">FRIENDLY</parameter>
<parameter name="quality">high</parameter>
<parameter name="enable_voice_chat">true</parameter>
<parameter name="knowledge_base">You are a helpful customer service representative.</parameter>
</invoke>
</function_calls>
```

### 2. avatar_speak

Make an avatar speak provided text with natural lip synchronization.

**Parameters:**
- `session_name` (required): Name of the avatar session
- `text` (required): Text for the avatar to speak
- `task_type`: Speaking task type (REPEAT, TALK)
- `task_mode`: Execution mode (SYNC, ASYNC)

**Example:**
```xml
<function_calls>
<invoke name="avatar_speak">
<parameter name="session_name">customer_service_avatar</parameter>
<parameter name="text">Hello! Welcome to our service. How can I help you today?</parameter>
<parameter name="task_type">REPEAT</parameter>
</invoke>
</function_calls>
```

### 3. start_voice_chat

Start interactive voice chat for real-time conversation with the avatar.

**Parameters:**
- `session_name` (required): Name of the avatar session
- `use_silence_prompt`: Enable automatic conversation prompts during silence
- `mute_input`: Start with user microphone muted

**Example:**
```xml
<function_calls>
<invoke name="start_voice_chat">
<parameter name="session_name">customer_service_avatar</parameter>
<parameter name="use_silence_prompt">true</parameter>
</invoke>
</function_calls>
```

### 4. stop_voice_chat

Stop interactive voice chat and return to text-only mode.

**Parameters:**
- `session_name` (required): Name of the avatar session

### 5. close_avatar_session

Close and terminate an active avatar session, freeing up resources.

**Parameters:**
- `session_name` (required): Name of the avatar session to close

### 6. list_avatar_sessions

List all active and stored avatar sessions with their status and configuration.

**Parameters:** None

## Usage Examples

### Basic Avatar Interaction

```xml
<!-- Create a session -->
<function_calls>
<invoke name="create_avatar_session">
<parameter name="session_name">demo_avatar</parameter>
<parameter name="voice_emotion">FRIENDLY</parameter>
<parameter name="quality">medium</parameter>
</invoke>
</function_calls>

<!-- Make the avatar speak -->
<function_calls>
<invoke name="avatar_speak">
<parameter name="session_name">demo_avatar</parameter>
<parameter name="text">Hello! I'm your AI assistant. How can I help you today?</parameter>
</invoke>
</function_calls>

<!-- Close the session when done -->
<function_calls>
<invoke name="close_avatar_session">
<parameter name="session_name">demo_avatar</parameter>
</invoke>
</function_calls>
```

### Interactive Voice Chat

```xml
<!-- Create a session with voice chat enabled -->
<function_calls>
<invoke name="create_avatar_session">
<parameter name="session_name">chat_avatar</parameter>
<parameter name="enable_voice_chat">true</parameter>
<parameter name="knowledge_base">You are a friendly conversational AI assistant.</parameter>
</invoke>
</function_calls>

<!-- Start voice chat -->
<function_calls>
<invoke name="start_voice_chat">
<parameter name="session_name">chat_avatar</parameter>
<parameter name="use_silence_prompt">true</parameter>
</invoke>
</function_calls>

<!-- Users can now speak directly to the avatar -->

<!-- Stop voice chat when finished -->
<function_calls>
<invoke name="stop_voice_chat">
<parameter name="session_name">chat_avatar</parameter>
</invoke>
</function_calls>
```

## File Management

The tool automatically manages session files in the sandbox workspace:

- **Session Files**: Stored in `avatars/{session_name}_session.json`
- **Directory Structure**: Creates `/workspace/avatars/` directory
- **Session Data**: Includes configuration, status, and metadata

## Credit Costs

HeyGen Video Avatar operations have the following credit costs:

- `create_avatar_session`: 5.0 credits (high cost for session setup)
- `avatar_speak`: 2.0 credits (moderate cost for text-to-speech)
- `start_voice_chat`: 3.0 credits (higher cost for voice chat setup)
- `stop_voice_chat`: 0.5 credits (low cost for stopping)
- `close_avatar_session`: 0.5 credits (low cost for cleanup)
- `list_avatar_sessions`: 0.3 credits (low cost for listing)

## Avatar and Voice Configuration

### Available Avatars

- **Public Avatars**: Several default avatars available for all users
- **Custom Avatars**: Create your own at [labs.heygen.com/interactive-avatar](https://labs.heygen.com/interactive-avatar)
- **Avatar IDs**: Get IDs from the HeyGen platform or use "default"

### Voice Settings

- **Voice IDs**: Use HeyGen's List Voices v2 API to get available voices
- **Emotions**: EXCITED, SERIOUS, FRIENDLY, SOOTHING, BROADCASTER
- **Rate**: 0.5 (slow) to 1.5 (fast), 1.0 is normal speed
- **Languages**: Support for multiple languages (en, es, fr, de, etc.)

## Best Practices

### Session Management

1. **Unique Names**: Use descriptive, unique session names
2. **Resource Cleanup**: Always close sessions when finished
3. **Timeout Settings**: Set appropriate timeouts based on use case
4. **Session Limits**: Be aware of concurrent session limits (3 for trial accounts)

### Performance Optimization

1. **Quality Settings**: Use appropriate quality for your bandwidth
2. **Voice Chat**: Only enable when needed for interactive conversations
3. **Session Duration**: Keep sessions as short as practical
4. **Error Handling**: Implement proper error handling for API failures

### User Experience

1. **Clear Instructions**: Provide users with clear guidance for voice interactions
2. **Fallback Options**: Have text alternatives when voice chat fails
3. **Visual Feedback**: Indicate avatar status (speaking, listening, idle)
4. **Graceful Degradation**: Handle network issues and API limitations

## Troubleshooting

### Common Issues

1. **API Key Errors**: Verify HEYGEN_API_KEY is set correctly
2. **Session Limits**: Check concurrent session usage
3. **Avatar/Voice IDs**: Ensure valid IDs from HeyGen platform
4. **Network Issues**: Handle timeout and connection errors
5. **Voice Chat**: Requires microphone permissions in browser

### Error Messages

- "HEYGEN_API_KEY is required": Set the API key in environment variables
- "Session already exists": Use a different session name or close existing session
- "Voice chat not enabled": Create session with `enable_voice_chat: true`
- "Session not found": Verify session name and create session first

## Integration Notes

### Frontend Integration

The tool works with HeyGen's Streaming Avatar SDK on the frontend:

```typescript
import StreamingAvatar, { AvatarQuality, StreamingEvents } from '@heygen/streaming-avatar';

// Initialize with session token from backend
const avatar = new StreamingAvatar({ token: sessionToken });

// Handle events
avatar.on(StreamingEvents.STREAM_READY, (event) => {
  // Attach video stream to DOM element
});

avatar.on(StreamingEvents.AVATAR_START_TALKING, () => {
  // Update UI to show avatar is speaking
});
```

### WebSocket Connection

- Sessions provide WebSocket URLs for real-time communication
- Frontend connects directly to HeyGen's streaming infrastructure
- Backend manages session lifecycle and configuration

## Security Considerations

1. **API Key Protection**: Never expose HeyGen API keys to frontend
2. **Session Tokens**: Use short-lived session tokens for frontend
3. **Access Control**: Implement proper user authentication
4. **Rate Limiting**: Monitor and limit API usage per user
5. **Data Privacy**: Be aware of voice and video data handling

## Limitations

1. **Concurrent Sessions**: Limited by HeyGen account type (3 for trial)
2. **Session Duration**: Maximum session duration varies by plan
3. **API Rate Limits**: Subject to HeyGen's API rate limiting
4. **Browser Support**: Voice chat requires modern browser with WebRTC
5. **Network Requirements**: Requires stable internet for video streaming

## Support and Resources

- [HeyGen API Documentation](https://docs.heygen.com/)
- [Streaming Avatar SDK](https://github.com/HeyGen-Official/StreamingAvatarSDK)
- [Interactive Avatar Platform](https://labs.heygen.com/interactive-avatar)
- [HeyGen Support](https://help.heygen.com/) 